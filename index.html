<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráficos Interativos com Rótulos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #ffffff;
        }
        canvas {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
        }
        button:hover {
            background-color: #ff6666;
        }
    </style>
</head>
<body>
    <h1>Gráficos Interativos</h1>

    <!-- Primeiro Gráfico -->
    <canvas id="chart1" width="800" height="400"></canvas>
    <button id="clearButton1">Limpar Dados do Gráfico 1</button>

    <!-- Segundo Gráfico -->
    <canvas id="chart2" width="800" height="400"></canvas>
    <button id="clearButton2">Limpar Dados do Gráfico 2</button>

    <script>
        const days = Array.from({ length: 32 }, (_, i) => i); // Dias de 0 a 31

        function createChart(canvasId, clearButtonId, storageKeyValues, storageKeyMotivos) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const storedValues = JSON.parse(localStorage.getItem(storageKeyValues)) || Array(32).fill(null);
            const storedMotivos = JSON.parse(localStorage.getItem(storageKeyMotivos)) || Array(32).fill(null);
            const values = [...storedValues];
            const motivos = [...storedMotivos];

            // Plugin para rótulos
            Chart.register({
                id: `${canvasId}DataLabelsPlugin`,
                afterDatasetsDraw(chart, args, options) {
                    const { ctx } = chart;
                    chart.data.datasets[0].data.forEach((value, index) => {
                        if (value !== null) {
                            const point = chart.getDatasetMeta(0).data[index];
                            const motivo = motivos[index];
                            ctx.save();
                            ctx.font = '12px Arial';
                            ctx.fillStyle = '#ffffff';
                            ctx.textAlign = 'center';
                            ctx.fillText(`R$ ${value}`, point.x, point.y - 10);
                            if (motivo) {
                                ctx.font = '10px Arial';
                                ctx.fillStyle = '#ffcc00';
                                ctx.fillText(motivo, point.x, point.y + 15);
                            }
                            ctx.restore();
                        }
                    });
                }
            });

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [
                        {
                            label: 'Valores Digitados',
                            data: values,
                            borderColor: 'cyan',
                            borderWidth: 2,
                            fill: false,
                            pointBackgroundColor: 'magenta',
                            pointRadius: 5,
                        },
                        {
                            label: 'Valores Acumulados',
                            data: calculateAccumulated(values),
                            borderColor: 'lime',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                        }
                    ],
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white',
                            },
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.raw || 0;
                                    const day = context.dataIndex;
                                    const motivo = motivos[day] ? `Motivo: ${motivos[day]}` : '';
                                    return [`R$ ${value}`, motivo];
                                },
                            },
                        },
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valor (R$)',
                                color: 'white',
                            },
                            ticks: {
                                callback: (value) => `R$ ${value}`,
                                color: 'white',
                            },
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Dias',
                                color: 'white',
                            },
                            ticks: {
                                color: 'white',
                            },
                        },
                    },
                    onClick: (e) => handleAxisClick(e),
                },
            });

            function calculateAccumulated(data) {
                return data.reduce((acc, val, i) => {
                    if (val !== null) acc.push((acc[i - 1] || 0) + val);
                    else acc.push(null);
                    return acc;
                }, []);
            }

            function handleAxisClick(event) {
                const xAxis = chart.scales.x;
                const xPosition = event.x;
                const closestDay = xAxis.getValueForPixel(xPosition);
                const roundedDay = Math.round(closestDay);
                if (roundedDay >= 0 && roundedDay <= 31) {
                    const newValue = prompt(`Digite o valor em R$ para o dia ${roundedDay}:`);
                    if (newValue !== null && !isNaN(newValue)) {
                        values[roundedDay] = parseFloat(newValue);
                        const motivo = prompt(`Digite o motivo para o valor no dia ${roundedDay}:`);
                        motivos[roundedDay] = motivo;
                        updateChart();
                    }
                }
            }

            function updateChart() {
                chart.data.datasets[0].data = values;
                chart.data.datasets[1].data = calculateAccumulated(values);
                localStorage.setItem(storageKeyValues, JSON.stringify(values));
                localStorage.setItem(storageKeyMotivos, JSON.stringify(motivos));
                chart.update();
            }

            document.getElementById(clearButtonId).addEventListener('click', () => {
                localStorage.removeItem(storageKeyValues);
                localStorage.removeItem(storageKeyMotivos);
                values.fill(null);
                motivos.fill(null);
                updateChart();
            });

            updateChart();
            return chart;
        }

        // Criação dos gráficos
        const chart1 = createChart('chart1', 'clearButton1', 'chart1Values', 'chart1Motivos');
        const chart2 = createChart('chart2', 'clearButton2', 'chart2Values', 'chart2Motivos');
    </script>
</body>
</html>
